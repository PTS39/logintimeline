<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js"></script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCHNHthCnCc4lvSSbWSdybcmPAZnhkgrVQ",
            authDomain: "linetimefirebase.firebaseapp.com",
            databaseURL: "https://linetimefirebase-default-rtdb.firebaseio.com",
            projectId: "linetimefirebase",
            storageBucket: "linetimefirebase.appspot.com",
            messagingSenderId: "936705360497",
            appId: "1:936705360497:web:8bcc8bf952e58d1f93d1d0",
            measurementId: "G-S3DHVD10LD"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    <script>
        // ฟังก์ชันที่มีอยู่ในโค้ดของคุณ
        function initializeLine() {
            liff.init({
                liffId: "2005997140-0qja2Nyx" // แทนที่ด้วย LIFF ID ของคุณ
            }).then(() => {
                if (liff.isLoggedIn()) {
                    liff.getProfile().then(profile => {
                        document.getElementById('fullName').innerText = profile.displayName;
                        document.getElementById('employeeId').innerText = profile.userId;
                        document.getElementById('position').innerText = "ตำแหน่ง"; // เพิ่มข้อมูลตำแหน่งหากมี
                    }).catch(err => console.error(err));
                } else {
                    liff.login();
                }
            }).catch(err => console.error(err));
        }

        function updateTime() {
            var now = new Date();
            var formattedTime = now.getFullYear() + '-' +
                ('0' + (now.getMonth() + 1)).slice(-2) + '-' +
                ('0' + now.getDate()).slice(-2) + ' ' +
                ('0' + now.getHours()).slice(-2) + ':' +
                ('0' + now.getMinutes()).slice(-2) + ':' +
                ('0' + now.getSeconds()).slice(-2);
            document.getElementById('currentTime').innerText = formattedTime;
        }

        setInterval(updateTime, 1000);
        window.onload = function() {
            updateTime();
            initializeLine();
        };

        function getLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var latitude = position.coords.latitude;
                    var longitude = position.coords.longitude;
                    callback(latitude, longitude);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; // รัศมีของโลก (เมตร)
            var φ1 = lat1 * Math.PI/180;
            var φ2 = lat2 * Math.PI/180;
            var Δφ = (lat2 - lat1) * Math.PI/180;
            var Δλ = (lon2 - lon1) * Math.PI/180;

            var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            var distance = R * c; // ระยะทางเป็นเมตร
            return distance;
        }

        function isValidClockInTime() {
            var now = new Date();
            var hours = now.getHours();
            return (hours >= 6 && hours <= 12);
        }

        function isValidClockOutTime() {
            var now = new Date();
            var hours = now.getHours();
            return (hours >= 13 || hours < 6);
        }

        function openForm(action) {
            if (action === 'Clock In' && !isValidClockInTime()) {
                alert("คุณสามารถกดปุ่ม Clock In ได้ในเวลา 06.00 ถึง 12.59 เท่านั้น");
                return;
            }
            if (action === 'Clock Out' && !isValidClockOutTime()) {
                alert("คุณสามารถกดปุ่ม Clock Out ได้ในเวลา 13.00 ถึง 05.59 เท่านั้น");
                return;
            }

            getLocation(function(latitude, longitude) {
                var officeLatitude = 15.2752837;  // กำหนดค่าที่ตั้งสำนักงาน
                var officeLongitude = 104.7960272;  // กำหนดค่าที่ตั้งสำนักงาน
                var distance = calculateDistance(latitude, longitude, officeLatitude, officeLongitude);

                var confirmMessage;
                if (distance > 999) {
                    var distanceKm = Math.floor(distance / 1000);
                    var distanceM = distance % 1000;
                    confirmMessage = "คุณอยู่นอกพื้นที่บริษัท คุณอยู่ห่างจากบริษัทประมาณ " + distanceKm + " กิโลเมตร " + distanceM.toFixed(2) + " เมตร คุณต้องการบันทึกข้อมูลหรือไม่?";
                } else if (distance > 10) {
                    confirmMessage = "คุณอยู่นอกพื้นที่บริษัท คุณอยู่ห่างจากบริษัทประมาณ " + distance.toFixed(2) + " เมตร คุณต้องการบันทึกข้อมูลหรือไม่?";
                }

                if (distance > 10 && !confirm(confirmMessage)) {
                    return;
                }

                var fullName = document.getElementById('fullName').innerText;
                var employeeId = document.getElementById('employeeId').innerText;
                var position = document.getElementById('position').innerText;
                var currentTime = document.getElementById('currentTime').innerText;

                document.getElementById('formEmployeeId').value = employeeId;
                document.getElementById('formFullName').value = fullName;
                document.getElementById('formPosition').value = position;
                document.getElementById('formLatitude').value = latitude;
                document.getElementById('formLongitude').value = longitude;
                document.getElementById('formAction').value = action;
                document.getElementById('formCurrentTime').value = currentTime;

                document.getElementById('formFullNameText').innerText = 'ชื่อ: ' + fullName;
                document.getElementById('formEmployeeIdText').innerText = 'รหัสพนักงาน: ' + employeeId;
                document.getElementById('formPositionText').innerText = 'ตำแหน่ง: ' + position;
                document.getElementById('formLatitudeText').innerText = 'Latitude: ' + latitude;
                document.getElementById('formLongitudeText').innerText = 'Longitude: ' + longitude;
                document.getElementById('formActionText').innerText = 'Action: ' + action;
                document.getElementById('formCurrentTimeText').innerText = 'Current Time: ' + currentTime;

                document.getElementById('overlay').style.display = 'block';
                document.getElementById('popupForm').style.display = 'block';
            });
        }

        function closeForm() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popupForm').style.display = 'none';
        }

        function submitForm() {
            var formData = {
                employeeId: document.getElementById('formEmployeeId').value,
                fullName: document.getElementById('formFullName').value,
                position: document.getElementById('formPosition').value,
                latitude: document.getElementById('formLatitude').value,
                longitude: document.getElementById('formLongitude').value,
                action: document.getElementById('formAction').value,
                currentTime: document.getElementById('formCurrentTime').value
            };

            // บันทึกข้อมูลลง Firebase Realtime Database
            firebase.database().ref('attendance').push(formData).then(() => {
                alert('บันทึกข้อมูลเรียบร้อยแล้ว');
                closeForm();
            }).catch(error => {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            });
        }

        function showLocationPopup() {
            getLocation(function(latitude, longitude) {
                var locationText = "Latitude: " + latitude + "\nLongitude: " + longitude;
                alert(locationText);
                showMap(latitude, longitude);
            });
        }

        var map; // กำหนดตัวแปร map ให้เป็น global

        function showMap(latitude, longitude) {
            var mapDiv = document.getElementById('map');
            mapDiv.style.display = 'block';

            if (map) {
                // ถ้า map มีอยู่แล้ว ให้เปลี่ยนตำแหน่งและซูมเข้า
                map.setView([latitude, longitude], 13);
                L.marker([latitude, longitude]).addTo(map)
                    .bindPopup('You are here.')
                    .openPopup();
            } else {
                // ถ้า map ยังไม่มี ให้สร้างใหม่
                map = L.map('map').setView([latitude, longitude], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                L.marker([latitude, longitude]).addTo(map)
                    .bindPopup('You are here.')
                    .openPopup();
            }
        }
    </script>
</head>
<body>
    <div class="profile-form">
        <h1>Profile</h1>
        <div class="container">
            <div class="main">
                <div class="content" id="contentid">
                    <h2>Profile Information</h2>
                    <p><strong>Full Name:</strong> <span id="fullName"></span></p>
                    <p><strong>Employee ID:</strong> <span id="employeeId"></span></p>
                    <p><strong>Position:</strong> <span id="position"></span></p>
                    <p><strong>Current Time:</strong> <span id="currentTime"></span></p>
                    <button type="button" class="btn btn-map" onclick="showLocationPopup()">กดเพื่อเช็คที่อยู่ของคุณ</button>

                    <div class="button-container">
                        <button id="clockIn" class="btn btn-clock-in" onclick="openForm('Clock In')">Clock In</button>
                        <button id="clockOut" class="btn btn-clock-out" onclick="openForm('Clock Out')">Clock Out</button>
                    </div>

                    <form action="logout.php" method="post">
                        <button type="submit" class="btn btn-logout">Logout</button>
                    </form>
                </div>
                <div class="form-map">
                    <div id="map" style="height: 400px; width: 100%; display: none;"></div>
                </div>
            </div>
            <!-- ฟอร์มป๊อปอัพ -->
            <div id="overlay"></div>
            <div id="popupForm" style="display:none;">
            <h2>Clock In/Out Confirmation</h2>
                <p id="formFullNameText"></p>
                <p id="formEmployeeIdText"></p>
                <p id="formPositionText"></p>
                <p id="formLatitudeText"></p>
                <p id="formLongitudeText"></p>
                <p id="formActionText"></p>
                <p id="formCurrentTimeText"></p>
                <form id="clockForm" method="POST" action="" enctype="multipart/form-data">
                    <input type="hidden" id="formEmployeeId" name="employeeId">
                    <input type="hidden" id="formFullName" name="fullName">
                    <input type="hidden" id="formPosition" name="position">
                    <input type="hidden" id="formLatitude" name="latitude">
                    <input type="hidden" id="formLongitude" name="longitude">
                    <input type="hidden" id="formAction" name="action">
                    <input type="hidden" id="formCurrentTime" name="currentTime">
                    <div class="button-container">
                        <button type="button" class="btn btn-danger" onclick="closeForm()">Close</button>
                        <button type="button" class="btn btn-primary" onclick="submitForm()">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
